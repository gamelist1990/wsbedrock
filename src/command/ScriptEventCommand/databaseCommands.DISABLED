import { jsonScoreboardDB } from "../../Modules/ScriptEvent/jsonScoreboardBridge";
import { registerScriptEvent } from "../../Modules/ScriptEvent/register";



// JSONãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
registerScriptEvent({
  name: 'jsondbtest',
  description: 'JSONãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;

    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // JSONãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    const testData1 = {
      name: player.name,
      level: 25,
      inventory: ["sword", "pickaxe", "food"],
      stats: {
        health: 100,
        mana: 50,
        experience: 1250
      }
    };

    const testData2 = {
      name: "Server Config",
      settings: {
        maxPlayers: 20,
        difficulty: "normal",
        pvpEnabled: true
      },
      lastUpdate: new Date().toISOString()
    };

    // JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚¹ãƒˆ
    let response = jsonScoreboardDB.setJson('player_profiles', 1001, testData1);
    player.sendMessage(`Â§a[JSON DB Test] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š: ${response.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
    console.log(`[JSON DB Test] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š: ${response.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);

    response = jsonScoreboardDB.setJson('server_settings', 2001, testData2);
    player.sendMessage(`Â§a[JSON DB Test] ã‚µãƒ¼ãƒãƒ¼è¨­å®š: ${response.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
    console.log(`[JSON DB Test] ã‚µãƒ¼ãƒãƒ¼è¨­å®š: ${response.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);

    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ†ã‚¹ãƒˆ
    response = jsonScoreboardDB.getJson('player_profiles', 1001);
    if (response.success) {
      player.sendMessage(`Â§b[JSON DB Test] å–å¾—æˆåŠŸ:`);
      player.sendMessage(`Â§f${JSON.stringify(response.data, null, 2)}`);
      console.log(`[JSON DB Test] å–å¾—æˆåŠŸ:`, response.data);
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ãƒ†ã‚¹ãƒˆ
    const updateData = {
      level: 30,
      "stats.experience": 1500
    };
    response = jsonScoreboardDB.updateJson('player_profiles', 1001, updateData);
    player.sendMessage(`Â§e[JSON DB Test] ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${response.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
    console.log(`[JSON DB Test] ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${response.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);

    // å­˜åœ¨ç¢ºèªãƒ†ã‚¹ãƒˆ
    response = jsonScoreboardDB.existsJson('player_profiles', 1001);
    player.sendMessage(`Â§d[JSON DB Test] ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª: ${response.data ? 'å­˜åœ¨ã™ã‚‹' : 'å­˜åœ¨ã—ãªã„'}`);
    console.log(`[JSON DB Test] ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª: ${response.data ? 'å­˜åœ¨ã™ã‚‹' : 'å­˜åœ¨ã—ãªã„'}`);

    // ä¸€è¦§è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
    response = jsonScoreboardDB.listJson('player_profiles');
    if (response.success && response.data) {
      player.sendMessage(`Â§6[JSON DB Test] ãƒ†ãƒ¼ãƒ–ãƒ«å†…å®¹:`);
      console.log(`[JSON DB Test] ãƒ†ãƒ¼ãƒ–ãƒ«å†…å®¹:`, response.data);
      for (const [id, data] of Object.entries(response.data)) {
        player.sendMessage(`Â§f  ID ${id}: ${JSON.stringify(data).substring(0, 100)}...`);
      }
    }
  },
});

// æ–‡å­—æ•°åˆ¶é™ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
registerScriptEvent({
  name: 'jsonlimittest',
  description: 'JSONãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ–‡å­—æ•°åˆ¶é™ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;

    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    player.sendMessage('Â§e[æ–‡å­—æ•°åˆ¶é™ãƒ†ã‚¹ãƒˆ] é–‹å§‹...');
    console.log('[jsonlimittest] æ–‡å­—æ•°åˆ¶é™ãƒ†ã‚¹ãƒˆé–‹å§‹');

    // ã‚ˆã‚Šå¹…åºƒãã¦è©³ç´°ãªãƒ†ã‚¹ãƒˆé•·ã‚’è¨­å®š
    const testLengths = [
      16, 32, 64, 100, 150, 200, 256, 300, 400, 500,
      600, 700, 800, 900, 1000, 1200, 1500, 2000,
      2500, 3000, 4000, 5000, 7500, 10000, 12000, 15000,
      20000, 25000, 30000, 35000, 40000, 45000, 50000,
      60000, 65536, 70000, 80000, 90000, 100000
    ];

    let maxSafeLength = 0;
    const testResults: Array<{ length: number, success: boolean }> = [];

    player.sendMessage('Â§6[åˆ¶é™ãƒ†ã‚¹ãƒˆ] å˜ç´”æ–‡å­—åˆ—ã§ãƒ†ã‚¹ãƒˆä¸­...');

    for (const length of testLengths) {
      // å˜ç´”ãªç¹°ã‚Šè¿”ã—æ–‡å­—ã§ãƒ†ã‚¹ãƒˆ
      const testString = 'a'.repeat(length);
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);

      testResults.push({
        length: length,
        success: result.success
      });

      if (result.success) {
        maxSafeLength = length;
        if (length % 1000 === 0 || length >= 10000) {
          player.sendMessage(`Â§a[åˆ¶é™ãƒ†ã‚¹ãƒˆ] ${length}æ–‡å­—ã¾ã§æˆåŠŸ`);
          console.log(`[jsonlimittest] ${length}æ–‡å­—ã¾ã§æˆåŠŸ`);
        }
      } else {
        // å¤±æ•—ã—ãŸæ™‚ç‚¹ã§è©³ç´°ã‚’å ±å‘Š
        player.sendMessage(`Â§c[åˆ¶é™ãƒ†ã‚¹ãƒˆ] ${length}æ–‡å­—ã§åˆå›å¤±æ•—æ¤œå‡º!`);
        console.log(`[jsonlimittest] ${length}æ–‡å­—ã§åˆå›å¤±æ•—æ¤œå‡º! ã‚¨ãƒ©ãƒ¼: ${result.error}`);
        break;
      }
    }

    player.sendMessage(`Â§a[åˆ¶é™ãƒ†ã‚¹ãƒˆ] å˜ç´”æ–‡å­—åˆ—ã®æœ€å¤§å®‰å…¨é•·: Â§f${maxSafeLength} æ–‡å­—`);
    console.log(`[jsonlimittest] å˜ç´”æ–‡å­—åˆ—ã®æœ€å¤§å®‰å…¨é•·: ${maxSafeLength} æ–‡å­—`);

    // ã‚ˆã‚Šè¤‡é›‘ãªJSONã§ãƒ†ã‚¹ãƒˆ
    player.sendMessage('Â§6[å®ŸJSON ãƒ†ã‚¹ãƒˆ] æ®µéšçš„ã«è¤‡é›‘ãªJSONã§ãƒ†ã‚¹ãƒˆ:');

    // æ®µéšçš„ã«è¤‡é›‘ãªJSONã‚’ç”Ÿæˆã—ã¦ãƒ†ã‚¹ãƒˆ
    const jsonTests = [
      // ãƒ¬ãƒ™ãƒ«1: åŸºæœ¬
      { "n": "t" },
      { "name": "test" },
      { "name": "player", "level": 1 },

      // ãƒ¬ãƒ™ãƒ«2: é…åˆ—è¿½åŠ 
      { "name": "player", "level": 25, "items": ["sword", "shield"] },
      { "name": "player", "level": 25, "items": ["sword", "shield", "potion", "food", "armor"] },

      // ãƒ¬ãƒ™ãƒ«3: ãƒã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      {
        "name": "complex_test",
        "data": {
          "level": 50,
          "stats": { "hp": 100, "mp": 50 }
        }
      },

      // ãƒ¬ãƒ™ãƒ«4: ã‚ˆã‚Šè¤‡é›‘
      {
        "playerName": "TestPlayer123456789",
        "playerLevel": 999999,
        "playerStats": {
          "health": 100,
          "mana": 75,
          "experience": 5000000,
          "strength": 85,
          "defense": 90,
          "speed": 75
        },
        "inventory": [
          "diamond_sword_of_sharpness_V",
          "iron_pickaxe_efficiency_IV",
          "golden_apple_enchanted",
          "enchanted_book_of_mending"
        ]
      }
    ];

    for (let i = 0; i < jsonTests.length; i++) {
      const jsonString = JSON.stringify(jsonTests[i]);
      const testResult = jsonScoreboardDB.testParticipantNameLimit(jsonString);

      const status = testResult.success ? 'Â§aæˆåŠŸ' : 'Â§cå¤±æ•—';
      player.sendMessage(`Â§f  ãƒ¬ãƒ™ãƒ«${i + 1} (${jsonString.length}æ–‡å­—): ${status}`);
      console.log(`[jsonlimittest] ãƒ¬ãƒ™ãƒ«${i + 1} (${jsonString.length}æ–‡å­—): ${status}`);

      if (!testResult.success) {
        player.sendMessage(`Â§c    å¤±æ•—ã—ãŸJSON: ${jsonString.substring(0, 100)}...`);
        console.log(`[jsonlimittest] å¤±æ•—ã—ãŸJSON: ${jsonString.substring(0, 100)}...`);
      }
    }

    // æ¥µé™ãƒ†ã‚¹ãƒˆ: å¤§é‡ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    player.sendMessage('Â§6[æ¥µé™ãƒ†ã‚¹ãƒˆ] å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ:');

    const extremeTests = [
      // å¤§é‡é…åˆ—
      {
        "items": Array.from({ length: 50 }, (_, i) => `item_${i}_with_long_name`)
      },
      // å¤§é‡ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      Object.fromEntries(Array.from({ length: 100 }, (_, i) => [`prop${i}`, `value${i}`])),
      // æ·±ã„ãƒã‚¹ãƒˆ
      {
        "level1": {
          "level2": {
            "level3": {
              "level4": {
                "level5": {
                  "data": Array.from({ length: 20 }, (_, i) => `deep_item_${i}`)
                }
              }
            }
          }
        }
      }
    ];

    for (let i = 0; i < extremeTests.length; i++) {
      const jsonString = JSON.stringify(extremeTests[i]);
      const testResult = jsonScoreboardDB.testParticipantNameLimit(jsonString);

      const status = testResult.success ? 'Â§aæˆåŠŸ' : 'Â§cå¤±æ•—';
      player.sendMessage(`Â§f  æ¥µé™${i + 1} (${jsonString.length}æ–‡å­—): ${status}`);
      console.log(`[jsonlimittest] æ¥µé™${i + 1} (${jsonString.length}æ–‡å­—): ${status}`);

      if (testResult.success) {
        player.sendMessage(`Â§7    æˆåŠŸä¾‹: ${jsonString.substring(0, 80)}...`);
      } else {
        player.sendMessage(`Â§c    å¤±æ•—ä¾‹: ${jsonString.substring(0, 80)}...`);
        player.sendMessage(`Â§c    ã‚¨ãƒ©ãƒ¼: ${testResult.error || 'ä¸æ˜'}`);
        console.log(`[jsonlimittest] å¤±æ•—ä¾‹: ${jsonString.substring(0, 80)}... ã‚¨ãƒ©ãƒ¼: ${testResult.error || 'ä¸æ˜'}`);
      }
    }

    // ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒã§æ­£ç¢ºãªé™ç•Œã‚’ç‰¹å®š
    player.sendMessage('Â§6[ç²¾å¯†ãƒ†ã‚¹ãƒˆ] ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒã§æ­£ç¢ºãªåˆ¶é™ã‚’ç‰¹å®šä¸­...');
    console.log('[jsonlimittest] ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒã§æ­£ç¢ºãªåˆ¶é™ã‚’ç‰¹å®šä¸­...');

    // ã‚ˆã‚Šåºƒç¯„å›²ã§ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒã‚’å®Ÿè¡Œ
    let low = maxSafeLength;
    let high = Math.max(maxSafeLength * 10, 100000);
    let preciseLimit = maxSafeLength;

    console.log(`[jsonlimittest] ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒç¯„å›²: ${low} - ${high}`);

    while (low <= high) {
      const mid = Math.floor((low + high) / 2);
      const testString = 'x'.repeat(mid);
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);

      console.log(`[jsonlimittest] ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒ: ${mid}æ–‡å­— - ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);

      if (result.success) {
        preciseLimit = mid;
        low = mid + 1;
      } else {
        high = mid - 1;
      }
    }

    player.sendMessage(`Â§a[ç²¾å¯†ãƒ†ã‚¹ãƒˆ] æ­£ç¢ºãªåˆ¶é™: Â§f${preciseLimit} æ–‡å­—`);
    player.sendMessage(`Â§e[ãƒ†ã‚¹ãƒˆå®Œäº†] participantåã®æœ€å¤§é•·ã¯ Â§f${preciseLimit} Â§eæ–‡å­—ã§ã™`);
    console.log(`[jsonlimittest] æ­£ç¢ºãªåˆ¶é™: ${preciseLimit} æ–‡å­—, participantåã®æœ€å¤§é•·: ${preciseLimit} æ–‡å­—`);
    
    // åˆ¶é™ä»˜è¿‘ã§ã®è©³ç´°ãƒ†ã‚¹ãƒˆ
    player.sendMessage('Â§6[å¢ƒç•Œãƒ†ã‚¹ãƒˆ] åˆ¶é™ä»˜è¿‘ã§ã®è©³ç´°æ¤œè¨¼...');
    console.log('[jsonlimittest] å¢ƒç•Œãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    const boundaryTests = [
      preciseLimit - 2,
      preciseLimit - 1,
      preciseLimit,
      preciseLimit + 1,
      preciseLimit + 2
    ];
    
    for (const testLength of boundaryTests) {
      if (testLength <= 0) continue;
      
      const testString = 'z'.repeat(testLength);
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);
      const status = result.success ? 'Â§aæˆåŠŸ' : 'Â§cå¤±æ•—';
      
      player.sendMessage(`Â§f  å¢ƒç•Œãƒ†ã‚¹ãƒˆ ${testLength}æ–‡å­—: ${status}`);
      console.log(`[jsonlimittest] å¢ƒç•Œãƒ†ã‚¹ãƒˆ ${testLength}æ–‡å­—: ${status}`);
    }
  },
});

// ç›´æ¥æ ¼ç´ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
registerScriptEvent({
  name: 'jsondirecttest',
  description: 'ç›´æ¥æ ¼ç´æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;

    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // å°ã•ãªJSONã§ç›´æ¥æ ¼ç´ãƒ†ã‚¹ãƒˆ
    const smallData = {
      "name": player.name,
      "level": 1,
      "coins": 100
    };

    player.sendMessage('Â§e[ç›´æ¥æ ¼ç´ãƒ†ã‚¹ãƒˆ] å°ã•ãªJSONã§ãƒ†ã‚¹ãƒˆ...');
    console.log('[jsondirecttest] å°ã•ãªJSONã§ãƒ†ã‚¹ãƒˆ...');

    let response = jsonScoreboardDB.setJsonDirect('test_direct', 5001, smallData);
    player.sendMessage(`Â§a[ç›´æ¥æ ¼ç´] è¨­å®š: ${response.success ? 'æˆåŠŸ' : `å¤±æ•— - ${response.error}`}`);
    console.log(`[jsondirecttest] è¨­å®š: ${response.success ? 'æˆåŠŸ' : `å¤±æ•— - ${response.error}`}`);

    if (response.success) {
      // å–å¾—ãƒ†ã‚¹ãƒˆ
      response = jsonScoreboardDB.getJsonDirect('test_direct', 5001);
      if (response.success) {
        player.sendMessage('Â§b[ç›´æ¥æ ¼ç´] å–å¾—æˆåŠŸ:');
        player.sendMessage(`Â§f${JSON.stringify(response.data, null, 2)}`);
        console.log('[jsondirecttest] å–å¾—æˆåŠŸ:', response.data);
      } else {
        player.sendMessage(`Â§c[ç›´æ¥æ ¼ç´] å–å¾—å¤±æ•—: ${response.error}`);
        console.log(`[jsondirecttest] å–å¾—å¤±æ•—: ${response.error}`);
      }
    }

    // ã‚ˆã‚Šå¤§ããªJSONã§ãƒ†ã‚¹ãƒˆ
    const largeData = {
      "playerName": player.name,
      "playerLevel": 25,
      "playerStats": {
        "health": 100,
        "mana": 75,
        "experience": 5000
      },
      "inventory": [
        "diamond_sword",
        "iron_pickaxe",
        "golden_apple",
        "enchanted_book"
      ],
      "achievements": ["first_kill", "first_craft", "level_10"]
    };

    player.sendMessage('Â§e[ç›´æ¥æ ¼ç´ãƒ†ã‚¹ãƒˆ] å¤§ããªJSONã§ãƒ†ã‚¹ãƒˆ...');
    console.log('[jsondirecttest] å¤§ããªJSONã§ãƒ†ã‚¹ãƒˆ...');

    response = jsonScoreboardDB.setJsonDirect('test_direct', 5002, largeData);
    player.sendMessage(`Â§a[ç›´æ¥æ ¼ç´] å¤§JSONè¨­å®š: ${response.success ? 'æˆåŠŸ' : `å¤±æ•— - ${response.error}`}`);
    console.log(`[jsondirecttest] å¤§JSONè¨­å®š: ${response.success ? 'æˆåŠŸ' : `å¤±æ•— - ${response.error}`}`);

    if (response.success) {
      response = jsonScoreboardDB.getJsonDirect('test_direct', 5002);
      if (response.success) {
        player.sendMessage('Â§b[ç›´æ¥æ ¼ç´] å¤§JSONå–å¾—æˆåŠŸ');
        // é•·ã„ã®ã§ä¸€éƒ¨ã®ã¿è¡¨ç¤º
        const dataStr = JSON.stringify(response.data);
        player.sendMessage(`Â§f${dataStr.substring(0, 100)}${dataStr.length > 100 ? '...' : ''}`);
      }
    }
  },
});

// é«˜ç²¾åº¦åˆ¶é™ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
registerScriptEvent({
  name: 'jsonexactlimit',
  description: 'é«˜ç²¾åº¦ã§æ­£ç¢ºãªæ–‡å­—æ•°åˆ¶é™ã‚’ç‰¹å®šã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;
    
    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    player.sendMessage('Â§e[é«˜ç²¾åº¦åˆ¶é™ãƒ†ã‚¹ãƒˆ] æ­£ç¢ºãªåˆ¶é™ã‚’ç‰¹å®šä¸­...');
    console.log('[jsonexactlimit] é«˜ç²¾åº¦åˆ¶é™ãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    // æ®µéšçš„æ¢ç´¢ã§å¤§ã¾ã‹ãªç¯„å›²ã‚’ç‰¹å®š
    player.sendMessage('Â§6[æ®µéš1] å¤§ã¾ã‹ãªç¯„å›²ã‚’ç‰¹å®šä¸­...');
    
    const quickTests = [1000000, 5000000, 10000000, 20000000, 50000000, 100000000, 200000000, 500000000, 1000000000];
    let lastSuccess = 0;
    let firstFailure = 1000000000;
    
    for (const testLength of quickTests) {
      const testString = 'T'.repeat(testLength);
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);
      
      if (result.success) {
        lastSuccess = testLength;
        player.sendMessage(`Â§a  ${testLength}æ–‡å­—: æˆåŠŸ`);
        console.log(`[jsonexactlimit] ${testLength}æ–‡å­—: æˆåŠŸ`);
      } else {
        firstFailure = testLength;
        player.sendMessage(`Â§c  ${testLength}æ–‡å­—: å¤±æ•—`);
        console.log(`[jsonexactlimit] ${testLength}æ–‡å­—: å¤±æ•— - ${result.error}`);
        break;
      }
    }
    
    // é«˜ç²¾åº¦ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒ
    player.sendMessage(`Â§6[æ®µéš2] é«˜ç²¾åº¦ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒ (${lastSuccess} - ${firstFailure})...`);
    console.log(`[jsonexactlimit] ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒç¯„å›²: ${lastSuccess} - ${firstFailure}`);
    
    const exactLimit = jsonScoreboardDB.findExactLimit(lastSuccess, firstFailure);
    
    player.sendMessage(`Â§a[çµæœ] æ­£ç¢ºãªåˆ¶é™: Â§f${exactLimit} æ–‡å­—`);
    console.log(`[jsonexactlimit] æ­£ç¢ºãªåˆ¶é™: ${exactLimit} æ–‡å­—`);
    
    // æœ€çµ‚ç¢ºèªãƒ†ã‚¹ãƒˆ
    player.sendMessage('Â§6[æœ€çµ‚ç¢ºèª] åˆ¶é™ä»˜è¿‘ã§ã®è©³ç´°æ¤œè¨¼...');
    
    const finalTests = [
      exactLimit - 5,
      exactLimit - 1, 
      exactLimit,
      exactLimit + 1,
      exactLimit + 5
    ];
    
    for (const testLength of finalTests) {
      if (testLength <= 0) continue;
      
      const testString = 'F'.repeat(testLength);
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);
      const status = result.success ? 'Â§aæˆåŠŸ' : 'Â§cå¤±æ•—';
      
      player.sendMessage(`Â§f  æœ€çµ‚ç¢ºèª ${testLength}æ–‡å­—: ${status}`);
      console.log(`[jsonexactlimit] æœ€çµ‚ç¢ºèª ${testLength}æ–‡å­—: ${status}`);
    }
    
    // ç‰¹æ®Šæ–‡å­—ã§ã®åˆ¶é™ãƒ†ã‚¹ãƒˆ
    player.sendMessage('Â§6[ç‰¹æ®Šæ–‡å­—ãƒ†ã‚¹ãƒˆ] Unicodeã§ã®åˆ¶é™ç¢ºèª...');
    
    const unicodeTests = [
      { name: 'ASCII', char: 'A' },
      { name: 'æ—¥æœ¬èª', char: 'ã‚' },
      { name: 'æ¼¢å­—', char: 'æ¼¢' },
      { name: 'çµµæ–‡å­—', char: 'ğŸ®' },
      { name: 'JSONè¨˜å·', char: '{' }
    ];
    
    for (const test of unicodeTests) {
      const testString = test.char.repeat(Math.floor(exactLimit / 2));
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);
      const status = result.success ? 'Â§aæˆåŠŸ' : 'Â§cå¤±æ•—';
      
      player.sendMessage(`Â§f  ${test.name} (${testString.length}æ–‡å­—): ${status}`);
      console.log(`[jsonexactlimit] ${test.name} ${testString.length}æ–‡å­—: ${status}`);
    }
    
    player.sendMessage(`Â§e[å®Œäº†] participantåã®æ­£ç¢ºãªåˆ¶é™: Â§f${exactLimit} Â§eæ–‡å­—`);
    console.log(`[jsonexactlimit] ãƒ†ã‚¹ãƒˆå®Œäº† - æ­£ç¢ºãªåˆ¶é™: ${exactLimit} æ–‡å­—`);
  },
});

// ãƒ¡ã‚¬ã‚µã‚¤ã‚ºåˆ¶é™ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡ç‰ˆï¼‰
registerScriptEvent({
  name: 'jsonmegalimit',
  description: 'éå¸¸ã«å¤§ããªæ–‡å­—æ•°åˆ¶é™ã‚’ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;
    
    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    player.sendMessage('Â§e[ãƒ¡ã‚¬åˆ¶é™ãƒ†ã‚¹ãƒˆ] è¶…å¤§å®¹é‡ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    console.log('[jsonmegalimit] ãƒ¡ã‚¬åˆ¶é™ãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    // ãƒ¡ã‚¬ã‚µã‚¤ã‚ºã®æ®µéšãƒ†ã‚¹ãƒˆ
    player.sendMessage('Â§6[æ®µéš1] ãƒ¡ã‚¬ã‚µã‚¤ã‚ºç¯„å›²ã®ç‰¹å®š...');
    
    const megaTests = [
      1000000,    // 1M
      5000000,    // 5M  
      10000000,   // 10M
      50000000,   // 50M
      100000000,  // 100M
      500000000,  // 500M
      1000000000, // 1G
      2000000000  // 2G (JavaScript ã®å®‰å…¨ãªæ•´æ•°åˆ¶é™ã«è¿‘ã„)
    ];
    
    let lastMegaSuccess = 0;
    let firstMegaFailure = 2000000000;
    
    for (const testLength of megaTests) {
      player.sendMessage(`Â§7[ãƒ¡ã‚¬ãƒ†ã‚¹ãƒˆ] ${(testLength / 1000000).toFixed(1)}Mæ–‡å­— ã‚’ãƒ†ã‚¹ãƒˆä¸­...`);
      console.log(`[jsonmegalimit] ${testLength}æ–‡å­— (${(testLength / 1000000).toFixed(1)}M) ãƒ†ã‚¹ãƒˆä¸­...`);
      
      let testString: string;
      try {
        // æ®µéšçš„ã«æ–‡å­—åˆ—ã‚’æ§‹ç¯‰ã—ã¦ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’åˆ¶å¾¡
        const chunkSize = 1000000; // 1Mãšã¤æ§‹ç¯‰
        const chunks = Math.floor(testLength / chunkSize);
        const remainder = testLength % chunkSize;
        
        testString = '';
        for (let i = 0; i < chunks; i++) {
          testString += 'x'.repeat(chunkSize);
          
          // é€²æ—è¡¨ç¤ºï¼ˆå¤§ããªãƒãƒ£ãƒ³ã‚¯ã®å ´åˆï¼‰
          if (chunks > 10 && i % Math.floor(chunks / 10) === 0) {
            console.log(`[jsonmegalimit] æ–‡å­—åˆ—æ§‹ç¯‰é€²æ—: ${((i / chunks) * 100).toFixed(1)}%`);
          }
        }
        if (remainder > 0) {
          testString += 'x'.repeat(remainder);
        }
        
        console.log(`[jsonmegalimit] ${testLength}æ–‡å­—ã®æ–‡å­—åˆ—æ§‹ç¯‰å®Œäº†`);
        
      } catch (memoryError) {
        player.sendMessage(`Â§c  ${(testLength / 1000000).toFixed(1)}Mæ–‡å­—: ãƒ¡ãƒ¢ãƒªä¸è¶³`);
        console.log(`[jsonmegalimit] ${testLength}æ–‡å­—: ãƒ¡ãƒ¢ãƒªä¸è¶³ - ${memoryError}`);
        firstMegaFailure = testLength;
        break;
      }
      
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);
      
      if (result.success) {
        lastMegaSuccess = testLength;
        player.sendMessage(`Â§a  ${(testLength / 1000000).toFixed(1)}Mæ–‡å­—: æˆåŠŸ`);
        console.log(`[jsonmegalimit] ${testLength}æ–‡å­—: æˆåŠŸ`);
        
        // ãƒ¡ãƒ¢ãƒªè§£æ”¾ã®ãŸã‚nullã«è¨­å®š
        testString = '';
        
      } else {
        firstMegaFailure = testLength;
        player.sendMessage(`Â§c  ${(testLength / 1000000).toFixed(1)}Mæ–‡å­—: å¤±æ•—`);
        console.log(`[jsonmegalimit] ${testLength}æ–‡å­—: å¤±æ•— - ${result.error}`);
        break;
      }
    }
    
    if (lastMegaSuccess === 0) {
      player.sendMessage('Â§c[çµæœ] 1Mæ–‡å­—ã§ã‚‚å¤±æ•—ã€‚å‰ã®ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // æˆåŠŸç¯„å›²ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (lastMegaSuccess >= firstMegaFailure) {
      player.sendMessage(`Â§a[çµæœ] ${(lastMegaSuccess / 1000000).toFixed(1)}Mæ–‡å­—ä»¥ä¸Šã§ã‚‚åˆ¶é™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
      player.sendMessage('Â§e[æ³¨æ„] JavaScript/ãƒ¡ãƒ¢ãƒªã®åˆ¶é™ã«ã‚ˆã‚Šã€ã“ã‚Œä»¥ä¸Šã®ãƒ†ã‚¹ãƒˆã¯å›°é›£ã§ã™');
      console.log(`[jsonmegalimit] ${lastMegaSuccess}æ–‡å­—ä»¥ä¸Šã§ã‚‚åˆ¶é™æœªç™ºè¦‹`);
    } else {
      player.sendMessage(`Â§6[æ®µéš2] ç²¾å¯†ç¯„å›²: ${(lastMegaSuccess / 1000000).toFixed(1)}M - ${(firstMegaFailure / 1000000).toFixed(1)}M`);
      console.log(`[jsonmegalimit] ç²¾å¯†ãƒ†ã‚¹ãƒˆç¯„å›²: ${lastMegaSuccess} - ${firstMegaFailure}`);
      
      // ã“ã®ç¯„å›²ã§ã‚ã‚Œã°é€šå¸¸ã®ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒã‚’å®Ÿè¡Œ
      player.sendMessage('Â§6[ãƒã‚¤ãƒŠãƒªã‚µãƒ¼ãƒ] ç²¾å¯†ãªåˆ¶é™ã‚’ç‰¹å®šä¸­...');
      const exactLimit = jsonScoreboardDB.findExactLimit(lastMegaSuccess, firstMegaFailure);
      
      player.sendMessage(`Â§a[æœ€çµ‚çµæœ] æ­£ç¢ºãªåˆ¶é™: Â§f${exactLimit} Â§aæ–‡å­— (${(exactLimit / 1000000).toFixed(2)}Mæ–‡å­—)`);
      console.log(`[jsonmegalimit] æœ€çµ‚çµæœ: ${exactLimit}æ–‡å­— (${(exactLimit / 1000000).toFixed(2)}Mæ–‡å­—)`);
    }
    
    console.log(`[jsonmegalimit] ãƒ¡ã‚¬ãƒ†ã‚¹ãƒˆå®Œäº†`);
  },
});

// æ ¼ç´ãƒ»å–å¾—æ•´åˆæ€§ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
registerScriptEvent({
  name: 'jsondataintegrity',
  description: 'æ ¼ç´ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;
    
    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    player.sendMessage('Â§e[æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ] ãƒ‡ãƒ¼ã‚¿æ ¼ç´ãƒ»å–å¾—ã®æ•´åˆæ€§ç¢ºèªé–‹å§‹...');
    console.log('[jsondataintegrity] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    // æ®µéšçš„ã«ã‚µã‚¤ã‚ºã‚’å¢—ã‚„ã—ã¦ãƒ†ã‚¹ãƒˆ
    const testSizes = [
      100,      // 100æ–‡å­—
      1000,     // 1K
      10000,    // 10K
      100000,   // 100K
      500000,   // 500K
      1000000,  // 1M
      5000000,  // 5M
      10000000  // 10M
    ];
    
    let maxIntegrityLength = 0;
    
    for (const testLength of testSizes) {
      player.sendMessage(`Â§6[æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ] ${(testLength / 1000).toFixed(0)}Kæ–‡å­—ã§ãƒ†ã‚¹ãƒˆä¸­...`);
      console.log(`[jsondataintegrity] ${testLength}æ–‡å­— (${(testLength / 1000).toFixed(1)}K) æ•´åˆæ€§ãƒ†ã‚¹ãƒˆä¸­...`);
      
      // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚€æ–‡å­—åˆ—ã§å‰Šã‚‰ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œå‡ºï¼‰
      const pattern = 'ABCDEFGHIJ';
      const baseString = pattern.repeat(Math.floor(testLength / pattern.length));
      const remainder = 'X'.repeat(testLength % pattern.length);
      const originalData = baseString + remainder;
      
      // å…ƒãƒ‡ãƒ¼ã‚¿ã®æƒ…å ±
      const originalLength = originalData.length;
      const originalHash = originalData.substring(0, 50) + '...' + originalData.substring(originalLength - 50);
      
      console.log(`[jsondataintegrity] å…ƒãƒ‡ãƒ¼ã‚¿é•·: ${originalLength}, ãƒ‘ã‚¿ãƒ¼ãƒ³: ${originalHash}`);
      
      // æ ¼ç´ãƒ†ã‚¹ãƒˆ
      const setResult = jsonScoreboardDB.testParticipantNameLimit(originalData);
      
      if (!setResult.success) {
        player.sendMessage(`Â§c  ${(testLength / 1000).toFixed(0)}Kæ–‡å­—: æ ¼ç´å¤±æ•—`);
        console.log(`[jsondataintegrity] ${testLength}æ–‡å­—: æ ¼ç´å¤±æ•— - ${setResult.error}`);
        break;
      }
      
      // å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ ¼ç´ã—ã¦å–å¾—ãƒ†ã‚¹ãƒˆ
      const testId = Math.floor(Math.random() * 1000000);
      const jsonData = { testData: originalData, testId: testId };
      
      const dbSetResult = jsonScoreboardDB.setJsonDirect('integrity_test', testId, jsonData);
      
      if (!dbSetResult.success) {
        player.sendMessage(`Â§c  ${(testLength / 1000).toFixed(0)}Kæ–‡å­—: DBæ ¼ç´å¤±æ•—`);
        console.log(`[jsondataintegrity] ${testLength}æ–‡å­—: DBæ ¼ç´å¤±æ•— - ${dbSetResult.error}`);
        break;
      }
      
      // ãƒ‡ãƒ¼ã‚¿å–å¾—
      const dbGetResult = jsonScoreboardDB.getJsonDirect('integrity_test', testId);
      
      if (!dbGetResult.success) {
        player.sendMessage(`Â§c  ${(testLength / 1000).toFixed(0)}Kæ–‡å­—: å–å¾—å¤±æ•—`);
        console.log(`[jsondataintegrity] ${testLength}æ–‡å­—: å–å¾—å¤±æ•— - ${dbGetResult.error}`);
        break;
      }
      
      // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      const retrievedData = dbGetResult.data.testData;
      const retrievedLength = retrievedData.length;
      const retrievedHash = retrievedData.substring(0, 50) + '...' + retrievedData.substring(retrievedLength - 50);
      
      console.log(`[jsondataintegrity] å–å¾—ãƒ‡ãƒ¼ã‚¿é•·: ${retrievedLength}, ãƒ‘ã‚¿ãƒ¼ãƒ³: ${retrievedHash}`);
      
      // æ•´åˆæ€§æ¤œè¨¼
      const isLengthMatch = originalLength === retrievedLength;
      const isContentMatch = originalData === retrievedData;
      
      if (isLengthMatch && isContentMatch) {
        maxIntegrityLength = testLength;
        player.sendMessage(`Â§a  ${(testLength / 1000).toFixed(0)}Kæ–‡å­—: æ•´åˆæ€§OK`);
        console.log(`[jsondataintegrity] ${testLength}æ–‡å­—: å®Œå…¨æ•´åˆæ€§ç¢ºèª`);
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        jsonScoreboardDB.deleteJson('integrity_test', testId);
        
      } else {
        player.sendMessage(`Â§c  ${(testLength / 1000).toFixed(0)}Kæ–‡å­—: æ•´åˆæ€§NG`);
        
        if (!isLengthMatch) {
          player.sendMessage(`Â§c    é•·ã•ä¸ä¸€è‡´: ${originalLength} â†’ ${retrievedLength} (${retrievedLength - originalLength}æ–‡å­—å·®)`);
          console.log(`[jsondataintegrity] é•·ã•ä¸ä¸€è‡´: ${originalLength} â†’ ${retrievedLength}`);
        }
        
        if (!isContentMatch) {
          player.sendMessage('Â§c    å†…å®¹ä¸ä¸€è‡´: ãƒ‡ãƒ¼ã‚¿ãŒæ”¹å¤‰ã•ã‚Œã¦ã„ã¾ã™');
          console.log(`[jsondataintegrity] å†…å®¹ä¸ä¸€è‡´æ¤œå‡º`);
          
          // å·®ç•°ã®è©³ç´°åˆ†æ
          let diffCount = 0;
          const maxDiffReport = 10;
          for (let i = 0; i < Math.min(originalLength, retrievedLength); i++) {
            if (originalData[i] !== retrievedData[i]) {
              if (diffCount < maxDiffReport) {
                console.log(`[jsondataintegrity] å·®ç•°@${i}: '${originalData[i]}' â†’ '${retrievedData[i]}'`);
              }
              diffCount++;
            }
          }
          console.log(`[jsondataintegrity] ç·å·®ç•°æ•°: ${diffCount}`);
        }
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        jsonScoreboardDB.deleteJson('integrity_test', testId);
        break;
      }
    }
    
    player.sendMessage(`Â§a[æ•´åˆæ€§ãƒ†ã‚¹ãƒˆçµæœ] å®Œå…¨æ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã‚‹æœ€å¤§é•·: Â§f${maxIntegrityLength}æ–‡å­— Â§a(${(maxIntegrityLength / 1000).toFixed(1)}Kæ–‡å­—)`);
    console.log(`[jsondataintegrity] æ•´åˆæ€§ãƒ†ã‚¹ãƒˆå®Œäº† - æœ€å¤§æ•´åˆæ€§é•·: ${maxIntegrityLength}æ–‡å­—`);
    
    // å®Ÿç”¨æ€§è©•ä¾¡
    player.sendMessage('Â§6[å®Ÿç”¨æ€§è©•ä¾¡] JSONãƒ‡ãƒ¼ã‚¿ã§ã®å®Ÿç”¨æ€§ç¢ºèª...');
    
    const practicalTests = [
      {
        name: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿',
        size: Math.floor(maxIntegrityLength * 0.1),
        generator: (size) => ({
          playerName: player.name,
          level: 100,
          stats: { hp: 1000, mp: 500 },
          inventory: Array.from({length: Math.floor(size / 50)}, (_, i) => `item_${i}`),
          achievements: Array.from({length: Math.floor(size / 100)}, (_, i) => `achievement_${i}`)
        })
      },
      {
        name: 'ã‚µãƒ¼ãƒãƒ¼è¨­å®š',
        size: Math.floor(maxIntegrityLength * 0.05),
        generator: (size) => ({
          serverName: 'Test Server',
          settings: Object.fromEntries(Array.from({length: Math.floor(size / 20)}, (_, i) => [`setting${i}`, `value${i}`])),
          rules: Array.from({length: Math.floor(size / 30)}, (_, i) => `rule_${i}`)
        })
      }
    ];
    
    for (const test of practicalTests) {
      try {
        const testData = test.generator(test.size);
        const jsonString = JSON.stringify(testData);
        
        player.sendMessage(`Â§7  ${test.name}: ${jsonString.length}æ–‡å­—`);
        console.log(`[jsondataintegrity] å®Ÿç”¨ãƒ†ã‚¹ãƒˆ - ${test.name}: ${jsonString.length}æ–‡å­—`);
        
        // ç°¡æ˜“æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        const testResult = jsonScoreboardDB.testParticipantNameLimit(jsonString);
        const status = testResult.success ? 'Â§aå®Ÿç”¨å¯èƒ½' : 'Â§cå®Ÿç”¨å›°é›£';
        player.sendMessage(`Â§f    çµæœ: ${status}`);
        
      } catch (error) {
        console.log(`[jsondataintegrity] å®Ÿç”¨ãƒ†ã‚¹ãƒˆå¤±æ•— - ${test.name}: ${error}`);
      }
    }
    
    console.log(`[jsondataintegrity] å…¨ãƒ†ã‚¹ãƒˆå®Œäº†`);
  },
});

// å¢ƒç•Œå€¤è©³ç´°ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
registerScriptEvent({
  name: 'jsonboundarytest',
  description: 'åˆ¶é™å¢ƒç•Œã§ã®è©³ç´°ãªæ ¼ç´ãƒ»å–å¾—ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™',
  parent: false,
  maxArgs: -1,
  minArgs: 0,
  require: 0,
  executor: (ev) => {
    const { player } = ev;
    
    if (!player) {
      console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    player.sendMessage('Â§e[å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ] åˆ¶é™å¢ƒç•Œã§ã®è©³ç´°ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    console.log('[jsonboundarytest] å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    // ã¾ãšæ¦‚ç®—ã®åˆ¶é™ã‚’è¦‹ã¤ã‘ã‚‹
    player.sendMessage('Â§6[æ®µéš1] æ¦‚ç®—åˆ¶é™ã®ç‰¹å®š...');
    
    let currentLimit = 1000000; // 1Mã‹ã‚‰é–‹å§‹
    let stepSize = 1000000;     // 1Mãšã¤å¢—åŠ 
    let foundLimit = 0;
    
    // å¤§ã¾ã‹ãªåˆ¶é™ã‚’è¦‹ã¤ã‘ã‚‹
    while (stepSize > 0) {
      const testString = 'X'.repeat(currentLimit);
      const result = jsonScoreboardDB.testParticipantNameLimit(testString);
      
      if (result.success) {
        foundLimit = currentLimit;
        currentLimit += stepSize;
        console.log(`[jsonboundarytest] ${foundLimit}æ–‡å­—: æˆåŠŸ, æ¬¡ã¯${currentLimit}æ–‡å­—ã‚’ãƒ†ã‚¹ãƒˆ`);
      } else {
        // å¤±æ•—ã—ãŸã®ã§ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦æˆ»ã‚‹
        stepSize = Math.floor(stepSize / 10);
        currentLimit = foundLimit + stepSize;
        
        console.log(`[jsonboundarytest] ${currentLimit}æ–‡å­—: å¤±æ•—, ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºã‚’${stepSize}ã«ç¸®å°`);
        
        if (stepSize < 1) {
          break;
        }
      }
      
      // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
      if (currentLimit > 2000000000) {
        console.log('[jsonboundarytest] åˆ¶é™ãŒ2Gã‚’è¶…ãˆã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆä¸­æ­¢ã€‚');
        break;
      }
    }
    
    player.sendMessage(`Â§a[æ®µéš1å®Œäº†] æ¦‚ç®—åˆ¶é™: Â§f${foundLimit}æ–‡å­—`);
    console.log(`[jsonboundarytest] æ¦‚ç®—åˆ¶é™ç‰¹å®š: ${foundLimit}æ–‡å­—`);
    
    // å¢ƒç•Œä»˜è¿‘ã§ã®è©³ç´°ãƒ†ã‚¹ãƒˆ
    player.sendMessage('Â§6[æ®µéš2] å¢ƒç•Œä»˜è¿‘ã®è©³ç´°ãƒ†ã‚¹ãƒˆ...');
    
    const boundaryRange = Math.min(1000, Math.floor(foundLimit * 0.01)); // 1%ã®ç¯„å›²ã€æœ€å¤§1000
    const startTest = Math.max(1, foundLimit - boundaryRange);
    const endTest = foundLimit + boundaryRange;
    
    console.log(`[jsonboundarytest] å¢ƒç•Œãƒ†ã‚¹ãƒˆç¯„å›²: ${startTest} - ${endTest}`);
    
    let preciseLimit = foundLimit;
    let integrityLimit = 0;
    
    for (let testLength = startTest; testLength <= endTest; testLength += Math.max(1, Math.floor(boundaryRange / 100))) {
      // æ ¼ç´ãƒ†ã‚¹ãƒˆ
      const testString = 'B'.repeat(testLength);
      const storeResult = jsonScoreboardDB.testParticipantNameLimit(testString);
      
      if (!storeResult.success) {
        console.log(`[jsonboundarytest] ${testLength}æ–‡å­—: æ ¼ç´å¤±æ•—ã§å¢ƒç•Œç¢ºå®š`);
        break;
      }
      
      preciseLimit = testLength;
      
      // æ•´åˆæ€§ãƒ†ã‚¹ãƒˆï¼ˆ100æ–‡å­—ã”ã¨ã«å®Ÿè¡Œï¼‰
      if (testLength % 100 === 0 || testLength >= endTest - 10) {
        const integrityResult = jsonScoreboardDB.testDataIntegrity(testString);
        
        if (integrityResult.success) {
          integrityLimit = testLength;
          console.log(`[jsonboundarytest] ${testLength}æ–‡å­—: æ•´åˆæ€§OK`);
        } else {
          player.sendMessage(`Â§c  ${testLength}æ–‡å­—: æ•´åˆæ€§NG`);
          console.log(`[jsonboundarytest] ${testLength}æ–‡å­—: æ•´åˆæ€§å¤±æ•— - ${integrityResult.error}`);
          
          if (!integrityResult.lengthMatch) {
            player.sendMessage(`Â§c    é•·ã•: ${integrityResult.originalLength} â†’ ${integrityResult.retrievedLength}`);
          }
        }
      }
      
      // é€²æ—è¡¨ç¤º
      if (testLength % Math.max(10, Math.floor(boundaryRange / 20)) === 0) {
        const progress = ((testLength - startTest) / (endTest - startTest) * 100).toFixed(1);
        player.sendMessage(`Â§7  å¢ƒç•Œãƒ†ã‚¹ãƒˆé€²æ—: ${progress}% (${testLength}æ–‡å­—)`);
      }
    }
    
    // çµæœå ±å‘Š
    player.sendMessage('Â§a[å¢ƒç•Œãƒ†ã‚¹ãƒˆå®Œäº†] çµæœ:');
    player.sendMessage(`Â§f  æ ¼ç´é™ç•Œ: Â§a${preciseLimit}æ–‡å­—`);
    player.sendMessage(`Â§f  æ•´åˆæ€§é™ç•Œ: Â§a${integrityLimit}æ–‡å­—`);
    
    console.log(`[jsonboundarytest] æœ€çµ‚çµæœ:`);
    console.log(`[jsonboundarytest] æ ¼ç´é™ç•Œ: ${preciseLimit}æ–‡å­—`);
    console.log(`[jsonboundarytest] æ•´åˆæ€§é™ç•Œ: ${integrityLimit}æ–‡å­—`);
    
    if (preciseLimit !== integrityLimit) {
      const unsafeBand = preciseLimit - integrityLimit;
      player.sendMessage(`Â§e[æ³¨æ„] ${integrityLimit + 1}æ–‡å­—ï½${preciseLimit}æ–‡å­—ã®ç¯„å›²ã¯æ ¼ç´å¯èƒ½ã ãŒå–å¾—æ™‚ã«ç ´æã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™`);
      console.log(`[jsonboundarytest] å±é™ºãªç¯„å›²: ${integrityLimit + 1} - ${preciseLimit}æ–‡å­— (${unsafeBand}æ–‡å­—å¹…)`);
    }
    
    // å®Ÿç”¨çš„ãªæ¨å¥¨å€¤
    const recommendedLimit = Math.floor(integrityLimit * 0.95); // 5%ã®ãƒãƒ¼ã‚¸ãƒ³
    player.sendMessage(`Â§b[æ¨å¥¨] å®Ÿç”¨çš„ãªå®‰å…¨é™ç•Œ: Â§f${recommendedLimit}æ–‡å­—`);
    console.log(`[jsonboundarytest] æ¨å¥¨å®‰å…¨é™ç•Œ: ${recommendedLimit}æ–‡å­—`);
    
    console.log('[jsonboundarytest] å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆå®Œäº†');
  },
});
